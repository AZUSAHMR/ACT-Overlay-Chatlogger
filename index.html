<!doctype HTML>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="./css/bootstrap.min.css" rel="stylesheet">
		<link href="./css/bootstrap-slider.min.css" rel="stylesheet">
		<link href="./css/logColor.css" rel="stylesheet">
		<style>
			body{
				width: 100vw;
				height: 100vh;
				max-width: 100vw;
				max-height: 100vh;
				background-color: rgba(0,0,0,.8);
				overflow: hidden;
			}

			#logPreview{
				overflow: auto;
			}

			.slider{
				width: 100% !important;
			}

			.logList{
				overflow-x: scroll;
				overflow-y: hidden;
				white-space: nowrap;
			}

			.logList button{
				margin-left: 10px;
				margin-right: 10px;
			}
            
            .fstyle {
                font-size: small;
                font-family: 'Malgun Gothic';
            }
		</style>
	</head>
	<body class="container-fluid">
		<div id="logPreview"></div>
		<script type="text/javascript" src="js/util.js"></script>
		<script type="text/javascript" src="js/listen.js"></script>
        <script src="./js/logColor.js"></script>
        <script src="./js/uiFuncitons.js"></script>
        <script src="./js/audioFunctions.js"></script>
		<script src="./js/jquery-1.12.4.min.js"></script>
		<script src="./js/bootstrap.min.js"></script>
		<script src="./js/bootstrap-slider.min.js"></script>
        <script src="./js/moment.js"></script>
		<script>
            function filterLog(type) {
                var isTalkLogEnabled = true;
                var isBattleLogEnabled = false;
                var isEventLogEnabled = true;

                if (type == 0 && isTalkLogEnabled) return true;
                if (type == 1 && isBattleLogEnabled) return true;
                if (type == 2 && isEventLogEnabled) return true;
                return false;
            }

			function printData(data){
				var timestamp = new Date(data.timestamp);
				var prefix = '<span class="colorTime">['+(timestamp.getHours()<10?"0"+timestamp.getHours():timestamp.getHours())+":"+(timestamp.getMinutes()<10?"0"+timestamp.getMinutes():timestamp.getMinutes())+']</span>';
				

				var decType = data.type&255;
				if(decType==24)
					prefix+="[자유부대]<"+data.nickname+"> ";
				else if(decType>=16&&decType<=23)
					prefix+="["+(decType-15)+"]<"+data.nickname+"> ";
				else if(decType==10||decType==11||decType==68||decType==30||decType==61)
					prefix+=data.nickname+": ";
				else if(decType==14)
					prefix+="("+data.nickname+") ";
				else if(decType==28)
					prefix+=data.nickname;
				else if(decType==12)
					prefix+=">>"+data.nickname+": ";
				else if(decType==13)
					prefix+=data.nickname+" >> ";
				else if(decType==15)
					prefix+="(("+data.nickname+")) ";
				else if(decType==27)
					prefix+="[초보자]<"+data.nickname+"> ";
				
				var type = getType(decType);
				if (filterLog(type)) {
				    $("#logPreview").append('<div class="type' + type + ' ' + getColor(decType) + ' code' + decType + ' fstyle" >' + prefix + $("<div></div>").text(data.data).html() + '</div>');
				    playSnd(decType);
				}
			}

			function printLog(){
				while($("#logPreview").prop("scrollHeight")-$("#logPreview").height()<=$("#logPreview").scrollTop()){
					if(window.meterI==window.workline.length)
						return;

					for(var i=window.meterI;window.meterI<window.workline.length&&window.meterI-i<50;window.meterI++){
						if(window.workline[window.meterI].type>=0)
							printData(window.workline[window.meterI]);
					}
				}
			}

			function escapeLog(text) {
			    text = text
                    .replace("", "1")
                    .replace("", "2")
                    .replace("", "3")
                    .replace("", "HQ")
                ;

                // 이하 아즈님이 원래 만드신거
				var startList = ["\u001c","\u0002","�","\u0003"];

				while(true){
					var start = startList.map(function(start){
						return text.indexOf(start);
					}).sort(function(cmp1,cmp2){
						if(cmp1==-1)
							return 1;
						else if(cmp2==-1)
							return -1;
						return cmp1>cmp2;
					})[0];

					if(start==-1)
						break;

					var target = text.substring(start,text.indexOf("\u0003")+"\u0003".length);
					text = text.replace(target,"");
				}

				text = text.replace(/[\u0001-\u001f]/g,"");
				text = text.replace(/[\ue000-\uf8ff]/g,"");

				return text;
			}

			document.addEventListener("onOverlayDataUpdate", function (data) {
			    if (!localStorage.activate)
			        return;
			    if (!data.detail)
			        return;

			    if (!window.meter)
			        window.meter = new window.Data(data.detail);
			    else
			        window.meter.update(data.detail);
			});

			document.addEventListener("onLogLine",function(data){
				if(!localStorage.activate)
					return;
				if(!data.detail)
					return;
				
				if(data.detail.opcode==0){
					window.timeline.push({
						timestamp: new Date(data.detail.timestamp).getTime(),
						type: parseInt(data.detail.payload[0],16),
						nickname: escapeLog(data.detail.payload[1]),
						data: escapeLog(data.detail.payload[2])
					});

					if(!window.pauseTimeline){
						printData(window.timeline[window.timeline.length-1]);
						noScroll();
					}
				}
				else if(data.detail.opcode==1){
					window.logline.push({
						timestamp: new Date(data.detail.timestamp).getTime(),
						type: -10,
						index: window.timeline.length-1,
						data: window.lastZone
					});

					window.lastZone = data.detail.payload[1];
				}
			});

			$(window).load(function(){
				resetTimeline();
				setHeight();
				$("#logPreview").scroll(printLog);
				$(window).resize(setHeight);
				activePlugin();
			});
		</script>
	</body>
</html>